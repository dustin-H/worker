"use strict";(self.webpackChunkgraphile_worker=self.webpackChunkgraphile_worker||[]).push([[6963],{9916:(e,n,r)=>{r.d(n,{xA:()=>u,yg:()=>m});var t=r(3696);function a(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function o(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach((function(n){a(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function l(e,n){if(null==e)return{};var r,t,a=function(e,n){if(null==e)return{};var r,t,a={},i=Object.keys(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||(a[r]=e[r]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=t.createContext({}),p=function(e){var n=t.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):o(o({},n),e)),r},u=function(e){var n=p(e.components);return t.createElement(s.Provider,{value:n},e.children)},g="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},y=t.forwardRef((function(e,n){var r=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),g=p(r),y=a,m=g["".concat(s,".").concat(y)]||g[y]||d[y]||i;return r?t.createElement(m,o(o({ref:n},u),{},{components:r})):t.createElement(m,o({ref:n},u))}));function m(e,n){var r=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=y;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[g]="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=r[p];return t.createElement.apply(null,o)}return t.createElement.apply(null,r)}y.displayName="MDXCreateElement"},8685:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var t=r(8102),a=(r(3696),r(9916));const i={title:"Library: running jobs",sidebar_position:60,sidebar_label:"Running jobs"},o=void 0,l={unversionedId:"library/run",id:"library/run",title:"Library: running jobs",description:"graphile-worker can be used as a library inside your Node.js application.",source:"@site/docs/library/run.md",sourceDirName:"library",slug:"/library/run",permalink:"/docs/library/run",draft:!1,editUrl:"https://github.com/graphile/worker/tree/main/website/docs/library/run.md",tags:[],version:"current",sidebarPosition:60,frontMatter:{title:"Library: running jobs",sidebar_position:60,sidebar_label:"Running jobs"},sidebar:"tutorialSidebar",previous:{title:"Library",permalink:"/docs/library/"},next:{title:"Queueing jobs",permalink:"/docs/library/queue"}},s={},p=[{value:"<code>run()</code>",id:"run",level:2},{value:"<code>runOnce()</code>",id:"runonce",level:2},{value:"<code>runMigrations()</code>",id:"runmigrations",level:2},{value:"<code>RunnerOptions</code>",id:"runneroptions",level:2},{value:"<code>Runner</code>",id:"runner",level:2},{value:"Example: <code>runner.addJob()</code>",id:"example-runneraddjob",level:3},{value:"Example: <code>runner.events</code>",id:"example-runnerevents",level:3}],u={toc:p},g="wrapper";function d(e){let{components:n,...r}=e;return(0,a.yg)(g,(0,t.A)({},u,r,{components:n,mdxType:"MDXLayout"}),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"graphile-worker")," can be used as a library inside your Node.js application.\nThere are two main use cases for this: running jobs, and queueing jobs. Here are\nthe APIs for running jobs."),(0,a.yg)("h2",{id:"run"},(0,a.yg)("inlineCode",{parentName:"h2"},"run()")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-ts"},"function run(options: RunnerOptions): Promise<Runner>;\n")),(0,a.yg)("p",null,"Runs until either stopped by a signal event like ",(0,a.yg)("inlineCode",{parentName:"p"},"SIGINT")," or by calling the\n",(0,a.yg)("inlineCode",{parentName:"p"},"stop()")," method on the resolved object."),(0,a.yg)("p",null,"The resolved ","\u2018","Runner","\u2019"," object has a number of helpers on it, see\n",(0,a.yg)("a",{parentName:"p",href:"#runner"},"Runner")," for more information."),(0,a.yg)("h2",{id:"runonce"},(0,a.yg)("inlineCode",{parentName:"h2"},"runOnce()")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-ts"},"function runOnce(options: RunnerOptions): Promise<void>;\n")),(0,a.yg)("p",null,"Equivalent to running the CLI with the ",(0,a.yg)("inlineCode",{parentName:"p"},"--once")," flag. The function will run\nuntil there are no runnable jobs left, and then resolve."),(0,a.yg)("h2",{id:"runmigrations"},(0,a.yg)("inlineCode",{parentName:"h2"},"runMigrations()")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-ts"},"function runMigrations(options: RunnerOptions): Promise<void>;\n")),(0,a.yg)("p",null,"Equivalent to running the CLI with the ",(0,a.yg)("inlineCode",{parentName:"p"},"--schema-only")," option. Runs the\nmigrations and then resolves."),(0,a.yg)("h2",{id:"runneroptions"},(0,a.yg)("inlineCode",{parentName:"h2"},"RunnerOptions")),(0,a.yg)("p",null,"The following options for these methods are available."),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"concurrency"),": The equivalent of the CLI ",(0,a.yg)("inlineCode",{parentName:"li"},"--jobs")," option with the same default\nvalue."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"noHandleSignals"),": If set true, we won","'","t install signal handlers and\nit","'","ll be up to you to handle graceful shutdown of the worker if the\nprocess receives a signal."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"pollInterval"),": The equivalent of the CLI ",(0,a.yg)("inlineCode",{parentName:"li"},"--poll-interval")," option with the\nsame default value."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"logger"),": To change how log messages are output you may provide a custom\nlogger; see ",(0,a.yg)("a",{parentName:"li",href:"/docs/library/logger"},(0,a.yg)("inlineCode",{parentName:"a"},"Logger")),"."),(0,a.yg)("li",{parentName:"ul"},"the database is identified through one of these options:",(0,a.yg)("ul",{parentName:"li"},(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"connectionString"),": A PostgreSQL\n",(0,a.yg)("a",{parentName:"li",href:"/docs/connection-string"},"connection string")," to the database containing the\njob queue, or"),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"pgPool"),": A ",(0,a.yg)("inlineCode",{parentName:"li"},"pg.Pool")," instance to use."))),(0,a.yg)("li",{parentName:"ul"},"the tasks to execute are identified through one of these options:",(0,a.yg)("ul",{parentName:"li"},(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"taskDirectory"),": A path string to a directory containing the task handlers."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"taskList"),": An object with the task names as keys and a corresponding task\nhandler functions as values."))),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"schema")," can be used to change the default ",(0,a.yg)("inlineCode",{parentName:"li"},"graphile_worker")," schema to\nsomething else (equivalent to ",(0,a.yg)("inlineCode",{parentName:"li"},"--schema")," on the CLI)."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"forbiddenFlags")," see ",(0,a.yg)("a",{parentName:"li",href:"/docs/forbidden-flags"},"Forbidden flags"),"."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"events"),": pass your own ",(0,a.yg)("inlineCode",{parentName:"li"},"new EventEmitter()")," if you want to customize the\noptions, get earlier events (before the runner object resolves), or want to\nget events from alternative Graphile Worker entrypoints."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"noPreparedStatements"),": Set true if you want to prevent the use of prepared\nstatements, for example if you wish to use Graphile Worker with an external\nPostgreSQL connection pool. Enabling this setting may have a small performance\nimpact.")),(0,a.yg)("p",null,"Exactly one of either ",(0,a.yg)("inlineCode",{parentName:"p"},"taskDirectory")," or ",(0,a.yg)("inlineCode",{parentName:"p"},"taskList")," must be provided (except for\n",(0,a.yg)("inlineCode",{parentName:"p"},"runMigrations")," which doesn","'","t require a task list)."),(0,a.yg)("p",null,"One of these must be provided (in order of priority):"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"pgPool")," pg.Pool instance"),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("a",{parentName:"li",href:"/docs/connection-string"},(0,a.yg)("inlineCode",{parentName:"a"},"connectionString"))," setting"),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"DATABASE_URL")," envvar"),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("a",{parentName:"li",href:"https://www.postgresql.org/docs/current/libpq-envars.html"},"PostgreSQL environmental variables"),",\nincluding at least ",(0,a.yg)("inlineCode",{parentName:"li"},"PGDATABASE")," (NOTE: not all envvars are supported)")),(0,a.yg)("h2",{id:"runner"},(0,a.yg)("inlineCode",{parentName:"h2"},"Runner")),(0,a.yg)("p",null,"The ",(0,a.yg)("inlineCode",{parentName:"p"},"run")," method above resolves to a ","\u2018","Runner","\u2019"," object that has the\nfollowing methods and properties:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"stop(): Promise<void>")," ","\u2014"," stops the runner from accepting new jobs, and\nreturns a promise that resolves when all the in progress tasks (if any) are\ncomplete."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"addJob: AddJobFunction")," ","\u2014"," see ",(0,a.yg)("a",{parentName:"li",href:"/docs/library/add-job"},(0,a.yg)("inlineCode",{parentName:"a"},"addJob")),"."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"promise: Promise<void>")," ","\u2014"," a promise that resolves once the runner has\ncompleted."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"events: WorkerEvents")," ","\u2014"," a Node.js ",(0,a.yg)("inlineCode",{parentName:"li"},"EventEmitter")," that exposes certain\nevents within the runner (see ",(0,a.yg)("a",{parentName:"li",href:"/docs/worker-events"},(0,a.yg)("inlineCode",{parentName:"a"},"WorkerEvents")),").")),(0,a.yg)("h3",{id:"example-runneraddjob"},"Example: ",(0,a.yg)("inlineCode",{parentName:"h3"},"runner.addJob()")),(0,a.yg)("p",null,"See ",(0,a.yg)("a",{parentName:"p",href:"/docs/library/add-job"},(0,a.yg)("inlineCode",{parentName:"a"},"addJob"))," for more details."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-js"},'await runner.addJob("testTask", {\n  thisIsThePayload: true,\n});\n')),(0,a.yg)("h3",{id:"example-runnerevents"},"Example: ",(0,a.yg)("inlineCode",{parentName:"h3"},"runner.events")),(0,a.yg)("p",null,"See ",(0,a.yg)("a",{parentName:"p",href:"/docs/worker-events"},(0,a.yg)("inlineCode",{parentName:"a"},"WorkerEvents"))," for more details."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-js"},'runner.events.on("job:success", ({ worker, job }) => {\n  console.log(`Hooray! Worker ${worker.workerId} completed job ${job.id}`);\n});\n')))}d.isMDXComponent=!0}}]);