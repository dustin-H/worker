"use strict";(self.webpackChunkgraphile_worker=self.webpackChunkgraphile_worker||[]).push([[5215],{9916:(e,r,t)=>{t.d(r,{xA:()=>p,yg:()=>f});var o=t(3696);function n(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function a(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?a(Object(t),!0).forEach((function(r){n(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function s(e,r){if(null==e)return{};var t,o,n=function(e,r){if(null==e)return{};var t,o,n={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],r.indexOf(t)>=0||(n[t]=e[t]);return n}(e,r);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t])}return n}var l=o.createContext({}),c=function(e){var r=o.useContext(l),t=r;return e&&(t="function"==typeof e?e(r):i(i({},r),e)),t},p=function(e){var r=c(e.components);return o.createElement(l.Provider,{value:r},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var r=e.children;return o.createElement(o.Fragment,{},r)}},h=o.forwardRef((function(e,r){var t=e.components,n=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(t),h=n,f=u["".concat(l,".").concat(h)]||u[h]||d[h]||a;return t?o.createElement(f,i(i({ref:r},p),{},{components:t})):o.createElement(f,i({ref:r},p))}));function f(e,r){var t=arguments,n=r&&r.mdxType;if("string"==typeof e||n){var a=t.length,i=new Array(a);i[0]=h;var s={};for(var l in r)hasOwnProperty.call(r,l)&&(s[l]=r[l]);s.originalType=e,s[u]="string"==typeof e?e:n,i[1]=s;for(var c=2;c<a;c++)i[c]=t[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}h.displayName="MDXCreateElement"},2693:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var o=t(8102),n=(t(3696),t(9916));const a={title:"Crashed worker recovery",sidebar_position:20},i=void 0,s={unversionedId:"pro/recovery",id:"pro/recovery",title:"Crashed worker recovery",description:"If a regular Graphile Worker process exits unexpectedly (for example someone",source:"@site/docs/pro/recovery.md",sourceDirName:"pro",slug:"/pro/recovery",permalink:"/docs/pro/recovery",draft:!1,editUrl:"https://github.com/graphile/worker/tree/main/website/docs/pro/recovery.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{title:"Crashed worker recovery",sidebar_position:20},sidebar:"tutorialSidebar",previous:{title:"Live migration",permalink:"/docs/pro/migration"},next:{title:"Pro configuration",permalink:"/docs/pro/config"}},l={},c=[{value:"Configuration",id:"configuration",level:2}],p={toc:c},u="wrapper";function d(e){let{components:r,...t}=e;return(0,n.yg)(u,(0,o.A)({},p,t,{components:r,mdxType:"MDXLayout"}),(0,n.yg)("p",null,"If a regular Graphile Worker process exits unexpectedly (for example someone\npulls the power lead from the server, or the Node.js process crashes or is\nkilled) it does not have a chance to unlock its active jobs, and they remain\nlocked for up to 4 hours. For some jobs, not being attempted again for 4 hours\ncould be far too long."),(0,n.yg)("p",null,"Worker Pro tracks running workers via a ","\u201c","heartbeat","\u201d",", and when a\nworker has not checked in for a configurable amount of time we can assume that\nthis worker is no longer active (crashed, was terminated, server shut down, etc)\nand release its jobs back to the pool to be executed (honouring\n",(0,n.yg)("a",{parentName:"p",href:"/docs/exponential-backoff"},"exponential backoff")," to help avoid crashes from\npoorly written task executors causing worker progress to stall)."),(0,n.yg)("admonition",{type:"note"},(0,n.yg)("p",{parentName:"admonition"},"Due to ",(0,n.yg)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/CAP_theorem"},"CAP theorem")," we cannot know\nit","'","s definitely safe to release jobs. In a standard production setup for\nGraphile Worker, you","'","ll have multiple (1 or more) workers, each worker may\nbe running on the same or different hardware, and they","'","ll all be talking to\none primary PostgreSQL server which will most likely be running on different\nhardware again."),(0,n.yg)("p",{parentName:"admonition"},"It","'","s possible for a worker to check out a job from the database and then\nlose connection to the database. The worker can continue to process its work\n(lets say doing a speech-to-text analysis of a long video) in the hopes the\ndatabase connection will be restored by the time it completes. If our\n","\u201c","cleanup process","\u201d"," runs before this happens then we might end up\naccidentally releasing and re-attempting the job when the worker is still in\nprogress. This is why the default 4 hour timeout exists in Graphile Worker, but\nin Pro we make it configurable for you ","\u2014"," it","'","s up to you to determine\nhow long you think a ","\u201c","net split","\u201d"," might persist between your worker\nand database.")),(0,n.yg)("h2",{id:"configuration"},"Configuration"),(0,n.yg)("p",null,"See ",(0,n.yg)("a",{parentName:"p",href:"/docs/pro/config"},"Pro configuration")," for details on how to configure Worker Pro,\nincluding the full meaning of each option."),(0,n.yg)("p",null,"The crash recovery feature relies on the following settings:"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"heartbeatInterval")," ","\u2014"," worker checkin frequency"),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"sweepInterval")," ","\u2014"," inactive worker check frequency"),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"sweepThreshold")," ","\u2014",' how long since the last heartbeat before a worker is\ndeemed "inactive"')),(0,n.yg)("admonition",{type:"info"},(0,n.yg)("p",{parentName:"admonition"},"It might take anywhere from ",(0,n.yg)("inlineCode",{parentName:"p"},"sweepThreshold")," to\n",(0,n.yg)("inlineCode",{parentName:"p"},"heartbeatInterval + sweepThreshold + sweepInterval")," (plus processing time, etc)\nmilliseconds for jobs from a crashed worker to be released.")))}d.isMDXComponent=!0}}]);